<!-- Generated by pkgdown: do not edit by hand -->
<!DOCTYPE html>
<html lang="en">
  <head>
  <meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1.0">

<title>Usage of the built in centroids by FCMm â€¢ FCMm</title>

<!-- favicons -->
<link rel="icon" type="image/png" sizes="16x16" href="../favicon-16x16.png">
<link rel="icon" type="image/png" sizes="32x32" href="../favicon-32x32.png">
<link rel="apple-touch-icon" type="image/png" sizes="180x180" href="../apple-touch-icon.png" />
<link rel="apple-touch-icon" type="image/png" sizes="120x120" href="../apple-touch-icon-120x120.png" />
<link rel="apple-touch-icon" type="image/png" sizes="76x76" href="../apple-touch-icon-76x76.png" />
<link rel="apple-touch-icon" type="image/png" sizes="60x60" href="../apple-touch-icon-60x60.png" />

<!-- jquery -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.4.1/jquery.min.js" integrity="sha256-CSXorXvZcTkaix6Yvo6HppcZGetbYMGWSFlBw8HfCJo=" crossorigin="anonymous"></script>
<!-- Bootstrap -->

<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/twitter-bootstrap/3.4.1/css/bootstrap.min.css" integrity="sha256-bZLfwXAP04zRMK2BjiO8iu9pf4FbLqX6zitd+tIvLhE=" crossorigin="anonymous" />

<script src="https://cdnjs.cloudflare.com/ajax/libs/twitter-bootstrap/3.4.1/js/bootstrap.min.js" integrity="sha256-nuL8/2cJ5NDSSwnKD8VqreErSWHtnEP9E7AySL+1ev4=" crossorigin="anonymous"></script>

<!-- bootstrap-toc -->
<link rel="stylesheet" href="../bootstrap-toc.css">
<script src="../bootstrap-toc.js"></script>

<!-- Font Awesome icons -->
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.12.1/css/all.min.css" integrity="sha256-mmgLkCYLUQbXn0B1SRqzHar6dCnv9oZFPEC1g1cwlkk=" crossorigin="anonymous" />
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.12.1/css/v4-shims.min.css" integrity="sha256-wZjR52fzng1pJHwx4aV2AO3yyTOXrcDW7jBpJtTwVxw=" crossorigin="anonymous" />

<!-- clipboard.js -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/clipboard.js/2.0.6/clipboard.min.js" integrity="sha256-inc5kl9MA1hkeYUt+EC3BhlIgyp/2jDIyBLS6k3UxPI=" crossorigin="anonymous"></script>

<!-- headroom.js -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/headroom/0.11.0/headroom.min.js" integrity="sha256-AsUX4SJE1+yuDu5+mAVzJbuYNPHj/WroHuZ8Ir/CkE0=" crossorigin="anonymous"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/headroom/0.11.0/jQuery.headroom.min.js" integrity="sha256-ZX/yNShbjqsohH1k95liqY9Gd8uOiE1S4vZc+9KQ1K4=" crossorigin="anonymous"></script>

<!-- pkgdown -->
<link href="../pkgdown.css" rel="stylesheet">
<script src="../pkgdown.js"></script>




<meta property="og:title" content="Usage of the built in centroids by FCMm" />
<meta property="og:description" content="FCMm" />
<meta property="og:image" content="/logo.png" />




<!-- mathjax -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/MathJax.js" integrity="sha256-nvJJv9wWKEm88qvoQl9ekL2J+k/RWIsaSScxxlsrv8k=" crossorigin="anonymous"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/config/TeX-AMS-MML_HTMLorMML.js" integrity="sha256-84DKXVJXs0/F8OTMzX4UR909+jtl4G7SPypPavF+GfA=" crossorigin="anonymous"></script>

<!--[if lt IE 9]>
<script src="https://oss.maxcdn.com/html5shiv/3.7.3/html5shiv.min.js"></script>
<script src="https://oss.maxcdn.com/respond/1.4.2/respond.min.js"></script>
<![endif]-->



  </head>

  <body data-spy="scroll" data-target="#toc">
    <div class="container template-article">
      <header>
      <div class="navbar navbar-default navbar-fixed-top" role="navigation">
  <div class="container">
    <div class="navbar-header">
      <button type="button" class="navbar-toggle collapsed" data-toggle="collapse" data-target="#navbar" aria-expanded="false">
        <span class="sr-only">Toggle navigation</span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
      </button>
      <span class="navbar-brand">
        <a class="navbar-link" href="../index.html">FCMm</a>
        <span class="version label label-default" data-toggle="tooltip" data-placement="bottom" title="Released version">0.7.2</span>
      </span>
    </div>

    <div id="navbar" class="navbar-collapse collapse">
      <ul class="nav navbar-nav">
        <li>
  <a href="../index.html">
    <span class="fas fa fas fa-home fa-lg"></span>
     
  </a>
</li>
<li>
  <a href="../reference/index.html">Reference</a>
</li>
<li class="dropdown">
  <a href="#" class="dropdown-toggle" data-toggle="dropdown" role="button" aria-expanded="false">
    Articles
     
    <span class="caret"></span>
  </a>
  <ul class="dropdown-menu" role="menu">
    <li>
      <a href="../articles/Cluster_a_new_dataset_by_FCMm.html">Cluster a new dataset by FCMm</a>
    </li>
    <li>
      <a href="../articles/Usage_of_the_built_in_centroids_by_FCMm.html">Usage of the built in centroids by FCMm</a>
    </li>
  </ul>
</li>
<li>
  <a href="../news/index.html">Changelog</a>
</li>
      </ul>
      <ul class="nav navbar-nav navbar-right">
        <li>
  <a href="https://github.com/bishun945/FCMm/">
    <span class="fab fa fab fa-github fa-lg"></span>
     
  </a>
</li>
      </ul>
      
    </div><!--/.nav-collapse -->
  </div><!--/.container -->
</div><!--/.navbar -->

      

      </header>


<div class="row">
  <div class="col-md-9 contents">
    <div class="page-header toc-ignore">
      <h1 data-toc-skip>Usage of the built in centroids by FCMm</h1>
                        <h4 class="author">Shun Bi</h4>
            
            <h4 class="date">2020-05-31</h4>
      
      <small class="dont-index">Source: <a href='https://github.com/bishun945/FCMm/blob/master/vignettes/Usage_of_the_built_in_centroids_by_FCMm.Rmd'><code>vignettes/Usage_of_the_built_in_centroids_by_FCMm.Rmd</code></a></small>
      <div class="hidden name"><code>Usage_of_the_built_in_centroids_by_FCMm.Rmd</code></div>

    </div>

    
    
<p>This vignette contains two parts to introduce the usage of the built-in centroids by FCMm (see more details in Bi <em>et al.</em> (2019)) when using (I) new coming in situ spectra and (II) new coming raster data.</p>
<div id="part-i-new-coming-in-situ-spectra" class="section level1">
<h1>Part I: New coming in situ spectra</h1>
<div id="preparing-the-data-set" class="section level2">
<h2>Preparing the data set</h2>
<p>This demo shows how to apply <code>FCMm</code> to a new data set if users just want to run it by the default cluster spectra and fuzzifier. The required data sets are <code>WaterSpec35</code> and <code>Bi_clusters</code>. The former is a dataset with water spectra of inland waters and corresponding Chla concentration (ug/L unit). The latter one is the seven water cluster spectra which trained by FCM-m method (see more details in Bi <em>et al.</em> (2019))</p>
<p><strong>Note_1</strong>: <code>WaterSpec35</code> is <strong>ONLY</strong> for the testing of <code>FCMm</code> in this package. If you want to use this dataset to your research, you should contact us to ask for the permit and more metadata about that by email <a href="mailto:liyunmei@njnu.edu.cn" class="email">liyunmei@njnu.edu.cn</a> and cc to <a href="mailto:bishun1994@foxmail.com" class="email">bishun1994@foxmail.com</a>. Hope you can understand.</p>
<p><strong>Note_2</strong>: The section <code>FCM running</code> used the default Rrs clusters. However, the input of Rrs data may not match the default wavelength settings such as quality control or atmospheric correction failure or so. Anyway, I have provided another section <code>One more thing</code> if your wavelength is not matching with the default.</p>
<div id="dataframe-process" class="section level3">
<h3>Dataframe process</h3>
<div class="sourceCode" id="cb1"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb1-1" data-line-number="1"><span class="kw">rm</span>(<span class="dt">list=</span><span class="kw">ls</span>())</a>
<a class="sourceLine" id="cb1-2" data-line-number="2"><span class="kw">library</span>(FCMm)</a>
<a class="sourceLine" id="cb1-3" data-line-number="3"><span class="kw">library</span>(ggplot2)</a>
<a class="sourceLine" id="cb1-4" data-line-number="4"><span class="kw">library</span>(magrittr)</a>
<a class="sourceLine" id="cb1-5" data-line-number="5"><span class="kw">data</span>(<span class="st">&quot;WaterSpec35&quot;</span>)</a>
<a class="sourceLine" id="cb1-6" data-line-number="6"><span class="kw">data</span>(<span class="st">&quot;Bi_clusters&quot;</span>)</a>
<a class="sourceLine" id="cb1-7" data-line-number="7">Rrs &lt;-<span class="st"> </span>WaterSpec35[,<span class="dv">3</span><span class="op">:</span><span class="dv">17</span>]</a></code></pre></div>
</div>
<div id="data-set-plots" class="section level3">
<h3>Data set plots</h3>
<p>At first, it is necessary to check out the dataframe situation before clustering (I suppose it is also important to do that in any other researches). The density plots show that the corresponding Chla concentration is severely skewed so it allows us to do a log10-transformed when estimate or validate the candidate algorithms.</p>
<p>Function <code>plot_spec_from_df()</code> offers a quick look about the spectral dataframe. Just type <code>help(FCMm::plot_spec_from_df)</code> to see more details.</p>
<p><strong>Note</strong>: The input of <code>plot_spec_from_df()</code> should be a matrix or data.frame with colnames that could be transformed into the numeric as the x-axis of the plot.</p>
<p>Anyway, the return of <code>plot_spec_from_df()</code> is a <code>ggplot</code> list which means you can do anything to it if you are familiar with the package <code>ggplot2</code>.</p>
<div class="sourceCode" id="cb2"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb2-1" data-line-number="1"><span class="kw">qplot</span>(<span class="dt">data=</span>WaterSpec35, <span class="dt">x=</span>Chla, <span class="dt">geom=</span><span class="st">&#39;density&#39;</span>, <span class="dt">xlab=</span><span class="st">&#39;The raw Chla&#39;</span>) <span class="op">+</span><span class="st"> </span></a>
<a class="sourceLine" id="cb2-2" data-line-number="2"><span class="st">  </span><span class="kw">theme_bw</span>() <span class="op">+</span><span class="st"> </span><span class="kw">theme</span>(<span class="dt">text =</span> <span class="kw">element_text</span>(<span class="dt">size=</span><span class="dv">13</span>))</a></code></pre></div>
<p><img src="Usage_of_the_built_in_centroids_by_FCMm_files/figure-html/unnamed-chunk-2-1.png" width="576" style="display: block; margin: auto;" /></p>
<div class="sourceCode" id="cb3"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb3-1" data-line-number="1"><span class="kw">qplot</span>(<span class="dt">data=</span>WaterSpec35, <span class="dt">x=</span>Chla, <span class="dt">geom=</span><span class="st">&#39;density&#39;</span>, <span class="dt">log=</span><span class="st">&#39;x&#39;</span>, <span class="dt">xlab=</span><span class="st">&#39;Log10 transformed Chla&#39;</span>) <span class="op">+</span><span class="st"> </span></a>
<a class="sourceLine" id="cb3-2" data-line-number="2"><span class="st">  </span><span class="kw">theme_bw</span>() <span class="op">+</span><span class="st"> </span><span class="kw">theme</span>(<span class="dt">text =</span> <span class="kw">element_text</span>(<span class="dt">size=</span><span class="dv">13</span>))</a></code></pre></div>
<p><img src="Usage_of_the_built_in_centroids_by_FCMm_files/figure-html/unnamed-chunk-2-2.png" width="576" style="display: block; margin: auto;" /></p>
<div class="sourceCode" id="cb4"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb4-1" data-line-number="1">p.spec &lt;-<span class="st"> </span><span class="kw">plot_spec_from_df</span>(Rrs) <span class="op">+</span><span class="st"> </span></a>
<a class="sourceLine" id="cb4-2" data-line-number="2"><span class="st">  </span><span class="kw">labs</span>(<span class="dt">x=</span><span class="st">&#39;Wavelength (nm)&#39;</span>,<span class="dt">y=</span><span class="kw">expression</span>(Rrs<span class="op">~</span>(sr<span class="op">^-</span><span class="dv">1</span>))) <span class="op">+</span><span class="st"> </span></a>
<a class="sourceLine" id="cb4-3" data-line-number="3"><span class="st">  </span><span class="kw">theme_bw</span>() <span class="op">+</span><span class="st"> </span></a>
<a class="sourceLine" id="cb4-4" data-line-number="4"><span class="st">  </span><span class="kw">theme</span>(<span class="dt">legend.position=</span><span class="st">&#39;none&#39;</span>, <span class="dt">text=</span><span class="kw">element_text</span>(<span class="dt">size=</span><span class="dv">13</span>))</a>
<a class="sourceLine" id="cb4-5" data-line-number="5"><span class="kw">print</span>(p.spec)</a></code></pre></div>
<p><img src="Usage_of_the_built_in_centroids_by_FCMm_files/figure-html/unnamed-chunk-2-3.png" width="576" style="display: block; margin: auto;" /></p>
</div>
</div>
<div id="fcm-running" class="section level2">
<h2>FCM running</h2>
<div id="clustering-the-new-data" class="section level3">
<h3>Clustering the new data</h3>
<p>Function <code>apply_FCM_m()</code> provides many parameters for users to decide the process for their desired results. In the following case, <code>result &lt;- apply_FCM_m(Rrs=Rrs)</code> is equal to <code>apply_FCM_m(Rrs=Rrs, wavelength=wavelength.default, Rrs_clusters=Rrs_clusters.default, stand=FALSE, default.cluster=TRUE, m_used=1.36, option.plot=TRUE)</code>. You can see more details by typing <code>help(FCMm::apply_FCM_m)</code>.</p>
<div class="sourceCode" id="cb5"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb5-1" data-line-number="1">result &lt;-<span class="st"> </span><span class="kw">apply_FCM_m</span>(<span class="dt">Rrs=</span>Rrs, <span class="dt">option.plot=</span><span class="ot">TRUE</span>)</a>
<a class="sourceLine" id="cb5-2" data-line-number="2"><span class="kw">summary</span>(result)</a>
<a class="sourceLine" id="cb5-3" data-line-number="3"><span class="co">#&gt;               Length Class      Mode   </span></a>
<a class="sourceLine" id="cb5-4" data-line-number="4"><span class="co">#&gt; x              15    data.frame list   </span></a>
<a class="sourceLine" id="cb5-5" data-line-number="5"><span class="co">#&gt; x.stand       525    -none-     numeric</span></a>
<a class="sourceLine" id="cb5-6" data-line-number="6"><span class="co">#&gt; d             245    -none-     numeric</span></a>
<a class="sourceLine" id="cb5-7" data-line-number="7"><span class="co">#&gt; u             245    -none-     numeric</span></a>
<a class="sourceLine" id="cb5-8" data-line-number="8"><span class="co">#&gt; Area           35    -none-     numeric</span></a>
<a class="sourceLine" id="cb5-9" data-line-number="9"><span class="co">#&gt; cluster        35    -none-     numeric</span></a>
<a class="sourceLine" id="cb5-10" data-line-number="10"><span class="co">#&gt; m_used          1    -none-     numeric</span></a>
<a class="sourceLine" id="cb5-11" data-line-number="11"><span class="co">#&gt; K               1    -none-     numeric</span></a>
<a class="sourceLine" id="cb5-12" data-line-number="12"><span class="co">#&gt; p.group         9    gg         list   </span></a>
<a class="sourceLine" id="cb5-13" data-line-number="13"><span class="co">#&gt; p.group.facet   9    gg         list   </span></a>
<a class="sourceLine" id="cb5-14" data-line-number="14"><span class="co">#&gt; dt.melt         4    data.frame list</span></a>
<a class="sourceLine" id="cb5-15" data-line-number="15">result<span class="op">$</span>p.group</a></code></pre></div>
<p><img src="Usage_of_the_built_in_centroids_by_FCMm_files/figure-html/unnamed-chunk-3-1.png" width="576" style="display: block; margin: auto;" /></p>
<p><code>result</code> list contains several result by <code>apply_FCM_M()</code> (partly same to a <code>FD</code> list):</p>
<ul>
<li><em>x</em>: the raw input Rrs dataframe with unit sr^-1</li>
<li><em>x.stand</em>: the standardized Rrs dataframe, if <code>stand=F</code></li>
<li><em>d</em>: distance to each cluster</li>
<li><em>u</em>: membership values</li>
<li><em>cluster</em>: defined by the maximum of membership</li>
<li><em>quality</em>: the quality of the cluster results. See more details in <code>help(FCMm::apply_FCM_m)</code></li>
<li><em>m.used</em>: the used value of fuzzifier(m)</li>
<li><em>K</em>: cluster number</li>
<li><em>p.group</em>: a ggplot list for plotting the cluster result</li>
<li><em>p.group.facet</em>: a ggplot list by facet for plotting the cluster result</li>
<li><em>dt.plot</em>: dataframe used for ggplot</li>
</ul>
</div>
<div id="estimating-chla-concentration-by-fcmm" class="section level3">
<h3>Estimating Chla concentration by FCMm</h3>
<p>Our package provides a new framework to estimate Chla concentration. The main point is <strong>algorithm blending</strong> which uses the advantages of candidates algorithm for their optimizing water type (such as TBA for turbid water and BR for relatively clear water). The three build-in algorithms used in <code>FCMm</code> are <code>TBA</code>, <code>BR</code>, and <code>Bloom</code>. Note that the <code>Bloom</code> model was designed for water bloom (or called harmful algal bloom waters with extremely high Chla concentration or scums). Please see more details in <code>help(FCMm::FCM_m_Chla_estiamtion)</code>.</p>
<div class="sourceCode" id="cb6"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb6-1" data-line-number="1"><span class="kw">library</span>(reshape2)</a>
<a class="sourceLine" id="cb6-2" data-line-number="2">dt_Chla &lt;-<span class="st"> </span><span class="kw">FCM_m_Chla_estimation</span>(<span class="dt">Rrs=</span><span class="kw">data.frame</span>(<span class="dt">Rrs665=</span>Rrs<span class="op">$</span><span class="st">`</span><span class="dt">665</span><span class="st">`</span>,</a>
<a class="sourceLine" id="cb6-3" data-line-number="3">                                                <span class="dt">Rrs709=</span>Rrs<span class="op">$</span><span class="st">`</span><span class="dt">708.75</span><span class="st">`</span>,</a>
<a class="sourceLine" id="cb6-4" data-line-number="4">                                                <span class="dt">Rrs754=</span>Rrs<span class="op">$</span><span class="st">`</span><span class="dt">753.75</span><span class="st">`</span>),</a>
<a class="sourceLine" id="cb6-5" data-line-number="5">                                 <span class="dt">U=</span>result<span class="op">$</span>u)</a>
<a class="sourceLine" id="cb6-6" data-line-number="6">dt_Chla<span class="op">$</span>cluster &lt;-<span class="st"> </span>result<span class="op">$</span>cluster <span class="op">%&gt;%</span><span class="st"> </span>as.character</a>
<a class="sourceLine" id="cb6-7" data-line-number="7">dt_Chla<span class="op">$</span>Chla_true &lt;-<span class="st"> </span>WaterSpec35<span class="op">$</span>Chla</a>
<a class="sourceLine" id="cb6-8" data-line-number="8"></a>
<a class="sourceLine" id="cb6-9" data-line-number="9"><span class="kw">options</span>(<span class="dt">scipen=</span><span class="dv">10000</span>)</a>
<a class="sourceLine" id="cb6-10" data-line-number="10"></a>
<a class="sourceLine" id="cb6-11" data-line-number="11"><span class="kw">subset</span>(dt_Chla, <span class="dt">select=</span><span class="kw">c</span>(<span class="st">&#39;cluster&#39;</span>,<span class="st">&#39;Chla_true&#39;</span>,<span class="st">&#39;BR&#39;</span>,<span class="st">&#39;TBA&#39;</span>,<span class="st">&#39;Bloom&#39;</span>,<span class="st">&#39;conc.Blend&#39;</span>)) <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb6-12" data-line-number="12"><span class="st">  </span><span class="kw">melt</span>(., <span class="dt">id=</span><span class="kw">c</span>(<span class="st">&#39;cluster&#39;</span>,<span class="st">&#39;Chla_true&#39;</span>)) <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb6-13" data-line-number="13"><span class="st">  </span><span class="kw">ggplot</span>(<span class="dt">data=</span>.) <span class="op">+</span><span class="st"> </span></a>
<a class="sourceLine" id="cb6-14" data-line-number="14"><span class="st">  </span><span class="kw">geom_point</span>(<span class="kw">aes</span>(<span class="dt">x=</span>Chla_true,<span class="dt">y=</span>value,<span class="dt">group=</span>cluster,<span class="dt">color=</span>cluster),</a>
<a class="sourceLine" id="cb6-15" data-line-number="15">             <span class="dt">alpha=</span><span class="fl">0.8</span>, <span class="dt">size=</span><span class="dv">4</span>) <span class="op">+</span></a>
<a class="sourceLine" id="cb6-16" data-line-number="16"><span class="st">  </span><span class="kw">scale_x_log10</span>(<span class="dt">limits=</span><span class="kw">c</span>(<span class="dv">1</span>,<span class="dv">800</span>)) <span class="op">+</span><span class="st"> </span></a>
<a class="sourceLine" id="cb6-17" data-line-number="17"><span class="st">  </span><span class="kw">scale_y_log10</span>(<span class="dt">limits=</span><span class="kw">c</span>(<span class="dv">1</span>,<span class="dv">800</span>)) <span class="op">+</span></a>
<a class="sourceLine" id="cb6-18" data-line-number="18"><span class="st">  </span><span class="kw">scale_color_manual</span>(<span class="dt">values=</span><span class="kw">RdYlBu</span>(result<span class="op">$</span>K)) <span class="op">+</span><span class="st"> </span></a>
<a class="sourceLine" id="cb6-19" data-line-number="19"><span class="st">  </span><span class="kw">labs</span>(<span class="dt">x=</span><span class="st">&#39;True value of Chla concentration (ug/L)&#39;</span>,</a>
<a class="sourceLine" id="cb6-20" data-line-number="20">       <span class="dt">y=</span><span class="st">&#39;Estimated value of Chla concentration (ug/L)&#39;</span>,</a>
<a class="sourceLine" id="cb6-21" data-line-number="21">       <span class="dt">color=</span><span class="st">&#39;Cluster&#39;</span>) <span class="op">+</span><span class="st"> </span></a>
<a class="sourceLine" id="cb6-22" data-line-number="22"><span class="st">  </span><span class="kw">geom_abline</span>(<span class="dt">intercept=</span><span class="dv">0</span>, <span class="dt">slope=</span><span class="dv">1</span>, <span class="dt">linetype=</span><span class="dv">2</span>) <span class="op">+</span><span class="st"> </span></a>
<a class="sourceLine" id="cb6-23" data-line-number="23"><span class="st">  </span><span class="kw">facet_wrap</span>(<span class="op">~</span>variable, <span class="dt">nrow=</span><span class="dv">2</span>) <span class="op">+</span><span class="st"> </span></a>
<a class="sourceLine" id="cb6-24" data-line-number="24"><span class="st">  </span><span class="kw">theme_bw</span>() <span class="op">+</span><span class="st"> </span></a>
<a class="sourceLine" id="cb6-25" data-line-number="25"><span class="st">  </span><span class="kw">theme</span>(<span class="dt">axis.text.x.bottom =</span> <span class="kw">element_text</span>(<span class="dt">hjust=</span><span class="dv">1</span>),</a>
<a class="sourceLine" id="cb6-26" data-line-number="26">        <span class="dt">strip.background =</span> <span class="kw">element_rect</span>(<span class="dt">color=</span><span class="st">&quot;white&quot;</span>, <span class="dt">fill=</span><span class="st">&quot;white&quot;</span>))</a></code></pre></div>
<p><img src="Usage_of_the_built_in_centroids_by_FCMm_files/figure-html/unnamed-chunk-4-1.png" width="576" style="display: block; margin: auto;" /></p>
<div class="sourceCode" id="cb7"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb7-1" data-line-number="1"></a>
<a class="sourceLine" id="cb7-2" data-line-number="2">MAPEs &lt;-<span class="st"> </span>MAEs &lt;-<span class="st"> </span><span class="ot">NULL</span></a>
<a class="sourceLine" id="cb7-3" data-line-number="3">i &lt;-<span class="st"> </span><span class="dv">1</span></a>
<a class="sourceLine" id="cb7-4" data-line-number="4"><span class="cf">for</span>(model <span class="cf">in</span> <span class="kw">c</span>(<span class="st">&#39;BR&#39;</span>,<span class="st">&#39;TBA&#39;</span>,<span class="st">&#39;Bloom&#39;</span>,<span class="st">&#39;conc.Blend&#39;</span>)){</a>
<a class="sourceLine" id="cb7-5" data-line-number="5">  MAPEs[i] &lt;-<span class="st"> </span><span class="kw">cal.metrics</span>(<span class="dt">x=</span>dt_Chla<span class="op">$</span>Chla_true <span class="op">%&gt;%</span><span class="st"> </span>log10,</a>
<a class="sourceLine" id="cb7-6" data-line-number="6">                          <span class="dt">y=</span>dt_Chla[,model]  <span class="op">%&gt;%</span><span class="st"> </span>log10,</a>
<a class="sourceLine" id="cb7-7" data-line-number="7">                          <span class="dt">name=</span><span class="st">&#39;MAPE&#39;</span>,<span class="dt">log10=</span><span class="ot">TRUE</span>)</a>
<a class="sourceLine" id="cb7-8" data-line-number="8">  MAEs[i] &lt;-<span class="st"> </span><span class="kw">cal.metrics</span>(<span class="dt">x=</span>dt_Chla<span class="op">$</span>Chla_true,</a>
<a class="sourceLine" id="cb7-9" data-line-number="9">                         <span class="dt">y=</span>dt_Chla[,model],</a>
<a class="sourceLine" id="cb7-10" data-line-number="10">                         <span class="dt">name=</span><span class="st">&#39;MAE&#39;</span>,<span class="dt">log10=</span><span class="ot">TRUE</span>)</a>
<a class="sourceLine" id="cb7-11" data-line-number="11">  <span class="kw">names</span>(MAPEs)[i] &lt;-<span class="st"> </span><span class="kw">names</span>(MAEs)[i] &lt;-<span class="st"> </span>model</a>
<a class="sourceLine" id="cb7-12" data-line-number="12">  i &lt;-<span class="st"> </span>i <span class="op">+</span><span class="st"> </span><span class="dv">1</span></a>
<a class="sourceLine" id="cb7-13" data-line-number="13">}</a>
<a class="sourceLine" id="cb7-14" data-line-number="14"><span class="kw">names</span>(MAPEs)[i<span class="dv">-1</span>] &lt;-<span class="st"> </span><span class="kw">names</span>(MAEs)[i<span class="dv">-1</span>] &lt;-<span class="st"> &#39;Blend&#39;</span></a>
<a class="sourceLine" id="cb7-15" data-line-number="15"><span class="kw">print</span>(MAPEs <span class="op">%&gt;%</span><span class="st"> </span><span class="kw">round</span>(<span class="dv">2</span>))</a>
<a class="sourceLine" id="cb7-16" data-line-number="16"><span class="co">#&gt;     BR    TBA  Bloom  Blend </span></a>
<a class="sourceLine" id="cb7-17" data-line-number="17"><span class="co">#&gt;  47.69  68.95 202.01  36.18</span></a>
<a class="sourceLine" id="cb7-18" data-line-number="18"><span class="kw">print</span>(MAEs <span class="op">%&gt;%</span><span class="st"> </span><span class="kw">round</span>(<span class="dv">3</span>))</a>
<a class="sourceLine" id="cb7-19" data-line-number="19"><span class="co">#&gt;    BR   TBA Bloom Blend </span></a>
<a class="sourceLine" id="cb7-20" data-line-number="20"><span class="co">#&gt; 0.254 0.225 0.928 0.199</span></a></code></pre></div>
<p>It is glad to see the Blending result performs better than others with its log-transformed MAPE = NA % and MAE = NA ug/L.</p>
</div>
</div>
<div id="one-more-thing" class="section level2">
<h2>One more thing</h2>
<p>As mentioned before, the input Rrs may do not match the default wavelength from <code>wavelength.default</code>. This section will show you how to do that kind of clustering by <code>FCMm</code>.</p>
<p>Here we suppose the selected bands are <code>412.5</code>, <code>442.5</code>, <code>490</code>, <code>510</code>, <code>560</code>, <code>620</code>, <code>665</code>, <code>673.75</code>, <code>708.75</code>, <code>753.75</code>, <code>865</code>, and <code>885</code>. Note that the <code>m.used</code> of <code>FD</code> list may change a little if different band number is used. But we assume the difference is negligible (i.e., still equal to the former one 1.36).</p>
<div class="sourceCode" id="cb8"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb8-1" data-line-number="1">Rrs_sub &lt;-<span class="st"> </span><span class="kw">subset</span>(Rrs, <span class="dt">select=</span><span class="kw">c</span>(<span class="st">`</span><span class="dt">412.5</span><span class="st">`</span>,<span class="st">`</span><span class="dt">442.5</span><span class="st">`</span>,<span class="st">`</span><span class="dt">490</span><span class="st">`</span>,<span class="st">`</span><span class="dt">510</span><span class="st">`</span>,</a>
<a class="sourceLine" id="cb8-2" data-line-number="2">                                <span class="st">`</span><span class="dt">560</span><span class="st">`</span>,<span class="st">`</span><span class="dt">620</span><span class="st">`</span>,<span class="st">`</span><span class="dt">665</span><span class="st">`</span>,<span class="st">`</span><span class="dt">673.75</span><span class="st">`</span>,</a>
<a class="sourceLine" id="cb8-3" data-line-number="3">                                <span class="st">`</span><span class="dt">708.75</span><span class="st">`</span>,<span class="st">`</span><span class="dt">753.75</span><span class="st">`</span>,<span class="st">`</span><span class="dt">865</span><span class="st">`</span>,<span class="st">`</span><span class="dt">885</span><span class="st">`</span>))</a>
<a class="sourceLine" id="cb8-4" data-line-number="4">wavelength.sub &lt;-<span class="st"> </span><span class="kw">c</span>(<span class="fl">412.5</span>,<span class="fl">442.5</span>,<span class="dv">490</span>,<span class="dv">510</span>,</a>
<a class="sourceLine" id="cb8-5" data-line-number="5">                    <span class="dv">560</span>,<span class="dv">620</span>,<span class="dv">665</span>,<span class="fl">673.75</span>,</a>
<a class="sourceLine" id="cb8-6" data-line-number="6">                    <span class="fl">708.75</span>,<span class="fl">753.75</span>,<span class="dv">865</span>,<span class="dv">885</span>)</a>
<a class="sourceLine" id="cb8-7" data-line-number="7">Rrs_clusters.sub &lt;-<span class="st"> </span><span class="kw">which</span>(<span class="kw">names</span>(Rrs_clusters.default) <span class="op">!=</span><span class="st"> &#39;X400&#39;</span> <span class="op">&amp;</span></a>
<a class="sourceLine" id="cb8-8" data-line-number="8"><span class="st">                            </span><span class="kw">names</span>(Rrs_clusters.default) <span class="op">!=</span><span class="st"> &#39;X681&#39;</span> <span class="op">&amp;</span><span class="st"> </span></a>
<a class="sourceLine" id="cb8-9" data-line-number="9"><span class="st">                            </span><span class="kw">names</span>(Rrs_clusters.default) <span class="op">!=</span><span class="st"> &#39;X779&#39;</span>) <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb8-10" data-line-number="10"><span class="st">  </span>Rrs_clusters.default[,.]</a>
<a class="sourceLine" id="cb8-11" data-line-number="11"></a>
<a class="sourceLine" id="cb8-12" data-line-number="12"><span class="co"># Note the parameter settings in this function `default.cluster=F`</span></a>
<a class="sourceLine" id="cb8-13" data-line-number="13">result_sub &lt;-<span class="st"> </span><span class="kw">apply_FCM_m</span>(<span class="dt">Rrs=</span>Rrs_sub, <span class="dt">wavelength=</span>wavelength.sub,</a>
<a class="sourceLine" id="cb8-14" data-line-number="14">                          <span class="dt">Rrs_clusters=</span>Rrs_clusters.sub,</a>
<a class="sourceLine" id="cb8-15" data-line-number="15">                          <span class="dt">stand=</span>F, <span class="dt">default.cluster=</span>F, <span class="dt">option.plot=</span>T)</a>
<a class="sourceLine" id="cb8-16" data-line-number="16">result_sub<span class="op">$</span>p.group</a></code></pre></div>
</div>
</div>
<div id="part-ii-new-coming-raster-data" class="section level1">
<h1>Part II: New coming raster data</h1>
<div id="preparing-the-data-set-1" class="section level2">
<h2>Preparing the data set</h2>
<p>This demo shows how to apply <code>FCMm</code> to raster data sets if users just want to run it for imagery application by the default cluster spectra and fuzzifier. The required data sets are <code>OLCI_TH</code> and <code>Bi_clusters</code>. The former is a dataset with atmospherically corrected OLCI rasters of inland waters that the AC method was demonstrated in Liu <em>et al.</em> (2015) (see more details about <code>OLCI_TH</code> by typing <code>help(OLCI_TH)</code>). The latter one is the seven water cluster spectra which trained by FCM-m method (see more details in Bi <em>et al.</em> (2019))</p>
<div id="dataframe-process-1" class="section level3">
<h3>Dataframe process</h3>
<p>The <code>OLCI_TH</code> is a <code>RasterBrick</code> of package <code>raster</code>. For running in <code>FCMm</code>, this <code>RasterBrick</code> should be converted as <code>ImageDataframe</code> so-called as <code>imdf</code>.</p>
<div class="sourceCode" id="cb9"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb9-1" data-line-number="1"><span class="kw">rm</span>(<span class="dt">list=</span><span class="kw">ls</span>())</a>
<a class="sourceLine" id="cb9-2" data-line-number="2"><span class="kw">library</span>(FCMm)</a>
<a class="sourceLine" id="cb9-3" data-line-number="3"><span class="kw">library</span>(ggplot2)</a>
<a class="sourceLine" id="cb9-4" data-line-number="4"><span class="kw">library</span>(magrittr)</a>
<a class="sourceLine" id="cb9-5" data-line-number="5"><span class="kw">data</span>(<span class="st">&quot;OLCI_TH&quot;</span>)</a>
<a class="sourceLine" id="cb9-6" data-line-number="6"><span class="kw">data</span>(<span class="st">&quot;Bi_clusters&quot;</span>)</a>
<a class="sourceLine" id="cb9-7" data-line-number="7"></a>
<a class="sourceLine" id="cb9-8" data-line-number="8"><span class="kw">class</span>(OLCI_TH)</a>
<a class="sourceLine" id="cb9-9" data-line-number="9"><span class="co">#&gt; [1] &quot;RasterBrick&quot;</span></a>
<a class="sourceLine" id="cb9-10" data-line-number="10"><span class="co">#&gt; attr(,&quot;package&quot;)</span></a>
<a class="sourceLine" id="cb9-11" data-line-number="11"><span class="co">#&gt; [1] &quot;raster&quot;</span></a>
<a class="sourceLine" id="cb9-12" data-line-number="12"></a>
<a class="sourceLine" id="cb9-13" data-line-number="13"><span class="co"># convert RasterBrick to imdf with NA value removed and xy coordinates recorded</span></a>
<a class="sourceLine" id="cb9-14" data-line-number="14">imdf &lt;-<span class="st"> </span>raster<span class="op">::</span><span class="kw">as.data.frame</span>(OLCI_TH, <span class="dt">na.rm=</span>T, <span class="dt">xy=</span><span class="ot">TRUE</span>)</a>
<a class="sourceLine" id="cb9-15" data-line-number="15"></a>
<a class="sourceLine" id="cb9-16" data-line-number="16">x_name &lt;-<span class="st"> </span><span class="kw">which</span>(<span class="kw">names</span>(imdf) <span class="op">==</span><span class="st"> &quot;x&quot;</span>)</a>
<a class="sourceLine" id="cb9-17" data-line-number="17">y_name &lt;-<span class="st"> </span><span class="kw">which</span>(<span class="kw">names</span>(imdf) <span class="op">==</span><span class="st"> &quot;y&quot;</span>)</a>
<a class="sourceLine" id="cb9-18" data-line-number="18">imdf &lt;-<span class="st"> </span><span class="kw">cbind</span>(imdf[,<span class="kw">c</span>(x_name, y_name)], imdf[,<span class="op">-</span><span class="kw">c</span>(x_name, y_name)])</a>
<a class="sourceLine" id="cb9-19" data-line-number="19"></a>
<a class="sourceLine" id="cb9-20" data-line-number="20"><span class="kw">names</span>(imdf)[<span class="op">-</span><span class="kw">c</span>(<span class="dv">1</span>,<span class="dv">2</span>)] &lt;-<span class="st"> </span><span class="kw">c</span>(<span class="fl">412.5</span>,<span class="fl">442.5</span>,<span class="dv">490</span>,<span class="dv">510</span>,</a>
<a class="sourceLine" id="cb9-21" data-line-number="21">                           <span class="dv">560</span>,<span class="dv">620</span>,<span class="dv">665</span>,<span class="fl">673.75</span>,</a>
<a class="sourceLine" id="cb9-22" data-line-number="22">                           <span class="fl">708.75</span>,<span class="fl">753.75</span>,<span class="dv">865</span>,<span class="dv">885</span>)</a></code></pre></div>
</div>
<div id="data-set-plots-1" class="section level3">
<h3>Data set plots</h3>
<div class="sourceCode" id="cb10"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb10-1" data-line-number="1"><span class="kw">set.seed</span>(<span class="dv">54321</span>)</a>
<a class="sourceLine" id="cb10-2" data-line-number="2">imdf[<span class="kw">sample</span>(<span class="dv">1</span><span class="op">:</span><span class="kw">nrow</span>(imdf),<span class="dv">50</span>),<span class="op">-</span><span class="kw">c</span>(<span class="dv">1</span>,<span class="dv">2</span>)] <span class="op">%&gt;%</span><span class="st"> </span></a>
<a class="sourceLine" id="cb10-3" data-line-number="3"><span class="st">  </span><span class="kw">plot_spec_from_df</span>(.) <span class="op">+</span><span class="st"> </span></a>
<a class="sourceLine" id="cb10-4" data-line-number="4"><span class="st">  </span><span class="kw">labs</span>(<span class="dt">x=</span><span class="st">&#39;Wavelength (nm)&#39;</span>,<span class="dt">y=</span><span class="kw">expression</span>(Rrs<span class="op">~</span>(sr<span class="op">^-</span><span class="dv">1</span>))) <span class="op">+</span><span class="st"> </span></a>
<a class="sourceLine" id="cb10-5" data-line-number="5"><span class="st">  </span><span class="kw">theme_bw</span>() <span class="op">+</span><span class="st"> </span></a>
<a class="sourceLine" id="cb10-6" data-line-number="6"><span class="st">  </span><span class="kw">theme</span>(<span class="dt">legend.position=</span><span class="st">&#39;none&#39;</span>, <span class="dt">text=</span><span class="kw">element_text</span>(<span class="dt">size=</span><span class="dv">18</span>))</a></code></pre></div>
<p><img src="Usage_of_the_built_in_centroids_by_FCMm_files/figure-html/unnamed-chunk-7-1.png" width="576" style="display: block; margin: auto;" /></p>
</div>
</div>
<div id="fcm-running-1" class="section level2">
<h2>FCM running</h2>
<div id="clustering-the-raster-and-chla-estimation" class="section level3">
<h3>Clustering the raster and Chla estimation</h3>
<p>Function <code>apply_to_image()</code> provides many parameters for users to decide the process for their desired results. You can see more details by typing <code>help(FCMm::apply_to_image)</code>.</p>
<p><strong>Note</strong>: The process might take a long time which depends on your local machine.</p>
<div class="sourceCode" id="cb11"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb11-1" data-line-number="1">res &lt;-<span class="st"> </span><span class="kw">generate_param</span>(<span class="kw">c</span>(<span class="dv">413</span>,<span class="dv">443</span>,<span class="dv">490</span>,<span class="dv">510</span>,<span class="dv">560</span>,<span class="dv">620</span>,<span class="dv">665</span>,<span class="dv">674</span>,<span class="dv">709</span>,<span class="dv">754</span>,<span class="dv">865</span>,<span class="dv">885</span>))</a>
<a class="sourceLine" id="cb11-2" data-line-number="2"></a>
<a class="sourceLine" id="cb11-3" data-line-number="3">im_result &lt;-<span class="st"> </span><span class="kw">apply_to_image</span>(<span class="dt">input=</span>OLCI_TH, <span class="dt">res=</span>res, <span class="dt">title.name=</span><span class="st">&quot;Test_image&quot;</span>,</a>
<a class="sourceLine" id="cb11-4" data-line-number="4">                            <span class="dt">Chla_est=</span>T, <span class="dt">output_image=</span>F)</a>
<a class="sourceLine" id="cb11-5" data-line-number="5"><span class="co">#&gt; Since we have not check the input image file,</span></a>
<a class="sourceLine" id="cb11-6" data-line-number="6"><span class="co">#&gt;   please make sure the wavelength of image file and cluster dataframe match correspondingly.</span></a>
<a class="sourceLine" id="cb11-7" data-line-number="7"><span class="co">#&gt; The normalization of spectra is default in thie version!</span></a>
<a class="sourceLine" id="cb11-8" data-line-number="8"><span class="co">#&gt; Apply fcm to image dataframe ......</span></a>
<a class="sourceLine" id="cb11-9" data-line-number="9"><span class="co">#&gt; Plotting membership values ......</span></a></code></pre></div>
<p><img src="Usage_of_the_built_in_centroids_by_FCMm_files/figure-html/unnamed-chunk-8-1.png" width="576" style="display: block; margin: auto;" /></p>
<pre><code>#&gt; Plotting clusters ......</code></pre>
<p><img src="Usage_of_the_built_in_centroids_by_FCMm_files/figure-html/unnamed-chunk-8-2.png" width="576" style="display: block; margin: auto;" /></p>
<pre><code>#&gt; Note: this function is designed for OLCI or MERIS band settings!
#&gt; The following bands (also as their names) must be contained in Rrs:
#&gt; Rrs665 Rrs709 Rrs754
#&gt; Plotting Chla concentration ......</code></pre>
<p><img src="Usage_of_the_built_in_centroids_by_FCMm_files/figure-html/unnamed-chunk-8-3.png" width="576" style="display: block; margin: auto;" /></p>
<pre><code>#&gt; Saving the results to the list ......
#&gt; output_membership
#&gt; output_cluster
#&gt; Done!</code></pre>
<p><img src="Usage_of_the_built_in_centroids_by_FCMm_files/figure-html/unnamed-chunk-8-4.png" width="576" style="display: block; margin: auto;" /></p>
<div class="sourceCode" id="cb15"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb15-1" data-line-number="1"><span class="kw">summary</span>(im_result)</a>
<a class="sourceLine" id="cb15-2" data-line-number="2"><span class="co">#&gt;                Length Class       Mode</span></a>
<a class="sourceLine" id="cb15-3" data-line-number="3"><span class="co">#&gt; input          791136 RasterBrick S4  </span></a>
<a class="sourceLine" id="cb15-4" data-line-number="4"><span class="co">#&gt; res                 3 -none-      list</span></a>
<a class="sourceLine" id="cb15-5" data-line-number="5"><span class="co">#&gt; raster.memb    346458 RasterBrick S4  </span></a>
<a class="sourceLine" id="cb15-6" data-line-number="6"><span class="co">#&gt; raster.cluster  49494 RasterLayer S4  </span></a>
<a class="sourceLine" id="cb15-7" data-line-number="7"><span class="co">#&gt; p.memb              9 gg          list</span></a>
<a class="sourceLine" id="cb15-8" data-line-number="8"><span class="co">#&gt; p.cluster           9 gg          list</span></a>
<a class="sourceLine" id="cb15-9" data-line-number="9"><span class="co">#&gt; p.truecolor         9 gg          list</span></a>
<a class="sourceLine" id="cb15-10" data-line-number="10"><span class="co">#&gt; p.Chla              9 gg          list</span></a>
<a class="sourceLine" id="cb15-11" data-line-number="11"><span class="co">#&gt; imdf               14 data.frame  list</span></a>
<a class="sourceLine" id="cb15-12" data-line-number="12"><span class="co">#&gt; imRrs.raw          12 data.frame  list</span></a>
<a class="sourceLine" id="cb15-13" data-line-number="13"><span class="co">#&gt; imRrs.n            12 data.frame  list</span></a>
<a class="sourceLine" id="cb15-14" data-line-number="14"><span class="co">#&gt; res.FCM             8 -none-      list</span></a>
<a class="sourceLine" id="cb15-15" data-line-number="15"><span class="co">#&gt; res.Chla           11 data.frame  list</span></a></code></pre></div>
<p><code>im_result</code> list contains several result by <code>apply_to_image()</code>:</p>
<ul>
<li><em>input</em>: what we input character link to image file or <code>raster</code> object</li>
<li><em>res</em>: condition input of <code>apply_to_image()</code></li>
<li><em>raster.memb</em>: raster object of membership value</li>
<li><em>raster.cluster</em>: raster object of cluster</li>
<li><em>p.memb</em>: ggplot list of membership value map</li>
<li><em>p.cluster</em>: ggplot list of cluster map</li>
<li><em>p.truecolor</em>: ggplot list of truecolor map</li>
<li><em>p.Chla</em>: ggplot list of Chla map</li>
<li><em>imdf</em>: data.frame of raw Rrs including xy coordinates</li>
<li><em>imRrs.raw</em>: data.frame of raw Rrs</li>
<li><em>imRrs.n</em>: data.frame of normalized Rrs</li>
<li><em>res.FCM</em>: list of <code>FCM.new()</code> result</li>
<li><em>res.Chla</em>: data.frame includes the template and final Chla estimation results</li>
</ul>
</div>
</div>
</div>
  </div>

  <div class="col-md-3 hidden-xs hidden-sm" id="pkgdown-sidebar">

        <nav id="toc" data-toggle="toc">
      <h2 data-toc-skip>Contents</h2>
    </nav>
      </div>

</div>



      <footer>
      <div class="copyright">
  <p>Developed by Shun Bi.</p>
</div>

<div class="pkgdown">
  <p>Site built with <a href="https://pkgdown.r-lib.org/">pkgdown</a> 1.5.1.</p>
</div>

      </footer>
   </div>

  


  </body>
</html>

